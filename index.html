<!DOCTYPE html>
  <html lang="de">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">

      <!-- Primary Meta Tags -->
      <title>RX-V577 by mrx3k1 Advanced Control - Professionelle AV-Receiver Steuerung</title>
      <meta name="title" content="RX-V577 by mrx3k1 Advanced Control - Professionelle AV-Receiver Steuerung">
      <meta name="description" content="Moderne Web-App zur vollständigen Kontrolle Ihres RX-V577 by mrx3k1 AV-Receivers. DSP-Programme, 7-Band-Equalizer, Lautsprecher-Konfiguration, HDMI-Einstellungen und mehr. 
  Responsive Design mit Dark Theme.">
      <meta name="keywords" content="Yamaha, RX-V577, AV-Receiver, Steuerung, DSP, Equalizer, HDMI, Surround Sound, Home Theater, Audio Control, Web App, Raspberry Pi">
      <meta name="author" content="Yamaha Receiver Control App">
      <meta name="robots" content="index, follow">
      <meta name="language" content="German">
      <meta name="revisit-after" content="7 days">

      <!-- Open Graph / Facebook -->
      <meta property="og:type" content="website">
      <meta property="og:url" content="http://localhost:5001/">
      <meta property="og:title" content="RX-V577 by mrx3k1 Advanced Control - Professionelle AV-Receiver Steuerung">
      <meta property="og:description" content="Moderne Web-App zur vollständigen Kontrolle Ihres RX-V577 by mrx3k1 AV-Receivers mit DSP-Programmen, Equalizer, Lautsprecher-Konfiguration und HDMI-Einstellungen.">
      <meta property="og:site_name" content="Yamaha Receiver Control">
      <meta property="og:locale" content="de_DE">

      <!-- Technical Meta Tags -->
      <meta name="application-name" content="Yamaha Receiver Control">
      <meta name="apple-mobile-web-app-capable" content="yes">
      <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
      <meta name="apple-mobile-web-app-title" content="Yamaha Control">
      <meta name="mobile-web-app-capable" content="yes">
      <meta name="theme-color" content="#2B2E3B">
      <meta name="color-scheme" content="dark">

      <!-- Favicon -->
      <link rel="icon" type="image/x-icon" href="/favicon.ico">
      <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
      <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
      <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
      <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
      <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png">


      <style>
          :root {
              /* Farbschema */
              --background-dark: #2B2E3B;
              --background-darker: #252830;
              --card-background: #343845;
              --accent-blue: #688db1;
              --accent-green: #9cb68f;
              --accent-red: #e16162;
              --text-primary: #d1d5db;
              --text-secondary: #9ca3af;

              /* Schatten */
              --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.25);
              --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.15);
              --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);

              /* Abstände */
              --spacing-1: 0.25rem;
              --spacing-2: 0.5rem;
              --spacing-3: 0.75rem;
              --spacing-4: 1rem;
              --spacing-6: 1.5rem;
              --spacing-8: 2rem;
              --spacing-12: 3rem;
              --spacing-16: 4rem;

              /* Rundungen */
              --radius-sm: 0.25rem;
              --radius: 0.5rem;
              --radius-lg: 0.75rem;
              --radius-xl: 1rem;

              /* Typografie */
              --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
          }

          * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
          }

          body {
              font-family: var(--font-family);
              background-color: var(--background-dark);
              color: var(--text-primary);
              min-height: 100vh;
              line-height: 1.6;
          }

          .header {
              background-color: var(--background-darker);
              padding: var(--spacing-6);
              box-shadow: var(--shadow);
              position: sticky;
              top: 0;
              z-index: 100;
          }

          .header h1 {
              font-size: 1.875rem;
              font-weight: 700;
              text-align: center;
              color: var(--text-primary);
              margin-bottom: var(--spacing-2);
          }

          .container {
              max-width: 1400px;
              margin: 0 auto;
              padding: var(--spacing-6);
          }

          .card {
              background-color: var(--card-background);
              border-radius: var(--radius-xl);
              padding: var(--spacing-6);
              margin-bottom: var(--spacing-6);
              box-shadow: var(--shadow);
              border: 1px solid rgba(255, 255, 255, 0.1);
          }

          .card h2 {
              font-size: 1.5rem;
              font-weight: 600;
              margin-bottom: var(--spacing-4);
              color: var(--accent-blue);
          }

          .card h3 {
              font-size: 1.25rem;
              font-weight: 500;
              margin-bottom: var(--spacing-3);
              color: var(--text-primary);
          }

          .grid {
              display: grid;
              gap: var(--spacing-6);
          }

          .grid-2 {
              grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
          }

          .grid-3 {
              grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          }

          .grid-4 {
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          }

          /* Buttons */
          .btn {
              padding: var(--spacing-3) var(--spacing-6);
              border: none;
              border-radius: var(--radius);
              font-size: 1rem;
              font-weight: 500;
              cursor: pointer;
              transition: all 0.3s ease;
              text-decoration: none;
              display: inline-flex;
              align-items: center;
              justify-content: center;
              gap: var(--spacing-2);
          }

          .btn-primary {
              background-color: var(--accent-blue);
              color: white;
          }

          .btn-primary:hover {
              background-color: #5a7a9a;
              transform: translateY(-1px);
              box-shadow: var(--shadow);
          }

          .btn-secondary {
              background-color: var(--accent-green);
              color: white;
          }

          .btn-secondary:hover {
              background-color: #8aa47d;
              transform: translateY(-1px);
              box-shadow: var(--shadow);
          }

          .btn-danger {
              background-color: var(--accent-red);
              color: white;
          }

          .btn-danger:hover {
              background-color: #d04f50;
              transform: translateY(-1px);
              box-shadow: var(--shadow);
          }

          .btn-outline {
              background-color: transparent;
              color: var(--accent-blue);
              border: 2px solid var(--accent-blue);
          }

          .btn-outline:hover {
              background-color: var(--accent-blue);
              color: white;
          }

          .btn:disabled {
              opacity: 0.6;
              cursor: not-allowed;
              transform: none;
          }

          .btn-sm {
              padding: var(--spacing-2) var(--spacing-4);
              font-size: 0.875rem;
          }

          .btn-lg {
              padding: var(--spacing-4) var(--spacing-8);
              font-size: 1.125rem;
          }

          /* Formulare */
          .form-group {
              margin-bottom: var(--spacing-4);
          }

          .form-label {
              display: block;
              margin-bottom: var(--spacing-2);
              font-weight: 500;
              color: var(--text-primary);
          }

          .form-input {
              width: 100%;
              padding: var(--spacing-3);
              background-color: var(--background-darker);
              border: 2px solid rgba(255, 255, 255, 0.1);
              border-radius: var(--radius);
              color: var(--text-primary);
              font-size: 1rem;
              transition: border-color 0.3s ease;
          }

          .form-input:focus {
              outline: none;
              border-color: var(--accent-blue);
              box-shadow: 0 0 0 3px rgba(104, 141, 177, 0.1);
          }

          .form-select {
              width: 100%;
              padding: var(--spacing-3);
              background-color: var(--background-darker);
              border: 2px solid rgba(255, 255, 255, 0.1);
              border-radius: var(--radius);
              color: var(--text-primary);
              font-size: 1rem;
              cursor: pointer;
          }

          .form-select:focus {
              outline: none;
              border-color: var(--accent-blue);
          }

          /* Slider */
          .slider-container {
              margin-bottom: var(--spacing-4);
          }

          .slider-label {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: var(--spacing-2);
          }

          .slider {
              width: 100%;
              height: 6px;
              border-radius: var(--radius);
              background: var(--background-darker);
              outline: none;
              -webkit-appearance: none;
              appearance: none;
          }

          .slider::-webkit-slider-thumb {
              -webkit-appearance: none;
              appearance: none;
              width: 24px;
              height: 24px;
              border-radius: 50%;
              background: var(--accent-blue);
              cursor: pointer;
              box-shadow: var(--shadow-sm);
              transition: all 0.3s ease;
          }

          .slider::-webkit-slider-thumb:hover {
              background: #5a7a9a;
              transform: scale(1.1);
              box-shadow: var(--shadow);
          }

          .slider::-moz-range-thumb {
              width: 24px;
              height: 24px;
              border-radius: 50%;
              background: var(--accent-blue);
              cursor: pointer;
              border: none;
              box-shadow: var(--shadow-sm);
          }

          /* Status-Anzeigen */
          .status-indicator {
              display: inline-flex;
              align-items: center;
              gap: var(--spacing-2);
              padding: var(--spacing-2) var(--spacing-4);
              border-radius: var(--radius);
              font-size: 0.875rem;
              font-weight: 500;
          }

          .status-connected {
              background-color: rgba(156, 182, 143, 0.2);
              color: var(--accent-green);
          }

          .status-disconnected {
              background-color: rgba(225, 97, 98, 0.2);
              color: var(--accent-red);
          }

          .status-warning {
              background-color: rgba(251, 191, 36, 0.2);
              color: #fbbf24;
          }

          .status-indicator::before {
              content: '';
              width: 8px;
              height: 8px;
              border-radius: 50%;
              background-color: currentColor;
          }

          /* Tabs */
          .tabs {
              display: flex;
              border-bottom: 2px solid rgba(255, 255, 255, 0.1);
              margin-bottom: var(--spacing-6);
              overflow-x: auto;
          }

          .tab {
              padding: var(--spacing-4) var(--spacing-6);
              background: none;
              border: none;
              color: var(--text-secondary);
              cursor: pointer;
              font-size: 1rem;
              font-weight: 500;
              white-space: nowrap;
              transition: all 0.3s ease;
              border-bottom: 3px solid transparent;
          }

          .tab:hover {
              color: var(--text-primary);
              background-color: rgba(255, 255, 255, 0.05);
          }

          .tab.active {
              color: var(--accent-blue);
              border-bottom-color: var(--accent-blue);
          }

          .tab-content {
              display: none;
          }

          .tab-content.active {
              display: block;
          }

          /* Power Button */
          .power-button {
              width: 80px;
              height: 80px;
              border-radius: 50%;
              border: 3px solid rgba(255, 255, 255, 0.3);
              background: var(--background-darker);
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              transition: all 0.3s ease;
              margin: 0 auto var(--spacing-4);
              position: relative;
              box-shadow: var(--shadow);
          }

          .power-button:hover {
              border-color: var(--accent-blue);
              transform: scale(1.05);
              box-shadow: var(--shadow-lg);
          }

          .power-button.on {
              border-color: var(--accent-green);
              background: rgba(156, 182, 143, 0.2);
              box-shadow: 0 0 20px rgba(156, 182, 143, 0.5);
          }

          .power-button svg {
              width: 40px;
              height: 40px;
              stroke: var(--text-secondary);
              fill: none;
              stroke-width: 2.5;
              transition: fill 0.3s ease;
          }

          .power-button.on svg {
              stroke: var(--accent-green);
          }

          /* Equalizer */
          .equalizer {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
              gap: var(--spacing-4);
              margin-top: var(--spacing-4);
          }

          .eq-band {
              text-align: center;
          }

          .eq-label {
              font-size: 0.875rem;
              color: var(--text-secondary);
              margin-bottom: var(--spacing-2);
          }

          .eq-slider {
              writing-mode: bt-lr;
              -webkit-appearance: slider-vertical;
              width: 100%;
              height: 120px;
              background: var(--background-darker);
              outline: none;
          }

          .eq-value {
              font-size: 0.75rem;
              color: var(--text-secondary);
              margin-top: var(--spacing-2);
          }

          /* Message */
          .message {
              position: fixed;
              bottom: var(--spacing-6);
              right: var(--spacing-6);
              padding: var(--spacing-4) var(--spacing-6);
              border-radius: var(--radius);
              color: white;
              font-weight: 500;
              box-shadow: var(--shadow-lg);
              opacity: 0;
              transform: translateY(20px);
              transition: all 0.3s ease;
              z-index: 1000;
              max-width: 400px;
          }

          .message.show {
              opacity: 1;
              transform: translateY(0);
          }

          .message.success {
              background-color: var(--accent-green);
          }

          .message.error {
              background-color: var(--accent-red);
          }

          .message.info {
              background-color: var(--accent-blue);
          }

          /* Responsive */
          @media (max-width: 768px) {
              .container {
                  padding: var(--spacing-4);
              }

              .grid-2,
              .grid-3,
              .grid-4 {
                  grid-template-columns: 1fr;
              }

              .tabs {
                  margin-bottom: var(--spacing-4);
              }

              .tab {
                  padding: var(--spacing-3) var(--spacing-4);
                  font-size: 0.875rem;
              }
          }

          /* Loading */
          .loading {
              display: inline-block;
              width: 20px;
              height: 20px;
              border: 3px solid rgba(255, 255, 255, 0.3);
              border-radius: 50%;
              border-top-color: var(--accent-blue);
              animation: spin 1s ease-in-out infinite;
          }

          @keyframes spin {
              to { transform: rotate(360deg); }
          }

          /* Progress Bar */
          .progress {
              width: 100%;
              height: 8px;
              background-color: var(--background-darker);
              border-radius: var(--radius);
              overflow: hidden;
          }

          .progress-bar {
              height: 100%;
              background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
              transition: width 0.3s ease;
              border-radius: var(--radius);
          }

          /* Connection Panel */
          .connection-panel {
              display: flex;
              align-items: center;
              gap: var(--spacing-4);
              flex-wrap: wrap;
          }

          .connection-panel .form-input {
              flex: 1;
              min-width: 200px;
          }

          /* Statistics Cards */
          .stats-grid {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
              gap: var(--spacing-4);
              margin-bottom: var(--spacing-6);
          }

          .stat-card {
              background: var(--background-darker);
              padding: var(--spacing-4);
              border-radius: var(--radius);
              text-align: center;
              border: 1px solid rgba(255, 255, 255, 0.1);
          }

          .stat-value {
              font-size: 2rem;
              font-weight: 700;
              color: var(--accent-blue);
          }

          .stat-label {
              font-size: 0.875rem;
              color: var(--text-secondary);
              margin-top: var(--spacing-1);
          }

          /* Collapsible connection panel */
          #connection-panel {
              transition: all 0.3s ease;
              overflow: hidden;
          }

          #connection-panel.collapsed {
              max-height: 0;
              margin-top: 0 !important;
              opacity: 0;
          }

          #toggle-icon {
              transition: transform 0.3s ease;
              display: inline-block;
          }

          #toggle-icon.collapsed {
              transform: rotate(-90deg);
          }

          /* Toggle Button Style */
          .toggle-container {
              display: flex;
              align-items: center;
              gap: var(--spacing-3);
              margin-top: var(--spacing-3);
          }

          .toggle-switch {
              position: relative;
              width: 60px;
              height: 32px;
              background: var(--background-darker);
              border-radius: 16px;
              cursor: pointer;
              transition: background 0.3s ease;
              border: 2px solid rgba(255, 255, 255, 0.2);
          }

          .toggle-switch.active {
              background: var(--accent-blue);
              border-color: var(--accent-blue);
          }

          .toggle-switch::after {
              content: '';
              position: absolute;
              top: 3px;
              left: 3px;
              width: 22px;
              height: 22px;
              background: white;
              border-radius: 50%;
              transition: transform 0.3s ease;
              box-shadow: var(--shadow-sm);
          }

          .toggle-switch.active::after {
              transform: translateX(28px);
          }

          .toggle-label {
              color: var(--text-light);
              font-size: 0.95rem;
              user-select: none;
              cursor: pointer;
          }

          /* Main Tabs */
          .main-tabs {
              display: flex;
              border-bottom: 2px solid rgba(255, 255, 255, 0.1);
              margin-bottom: var(--spacing-4);
              overflow-x: auto;
              background: var(--card-background);
              border-radius: var(--radius) var(--radius) 0 0;
          }

          .main-tab {
              padding: var(--spacing-4) var(--spacing-6);
              background: none;
              border: none;
              color: var(--text-secondary);
              cursor: pointer;
              font-size: 1rem;
              font-weight: 500;
              white-space: nowrap;
              transition: all 0.3s ease;
              border-bottom: 3px solid transparent;
              flex: 1;
              min-width: 120px;
          }

          .main-tab:hover {
              color: var(--text-primary);
              background-color: rgba(255, 255, 255, 0.05);
          }

          .main-tab.active {
              color: var(--accent-blue);
              border-bottom-color: var(--accent-blue);
              background-color: rgba(104, 141, 177, 0.1);
          }

          /* Tab Content */
          .tab-content {
              display: none;
          }

          .tab-content.active {
              display: block;
          }

          @media (max-width: 768px) {
              .main-tab {
                  font-size: 0.9rem;
                  padding: var(--spacing-3) var(--spacing-4);
                  min-width: 100px;
              }
          }
      </style>
  </head>
  <body>
      <header class="header">
          <h1>🔊 RX-V577 by mrx3k1</h1>
          <div class="card" id="connection-card">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                  <h3 style="margin: 0; font-size: 1rem;">Verbindung</h3>
                  <button class="btn btn-sm" id="toggle-connection" style="background: transparent; border: none; color: var(--text-light); font-size: 1.2rem; padding: 0.25rem 0.5rem;">
                      <span id="toggle-icon">▼</span>
                  </button>
              </div>
              <div class="connection-panel" id="connection-panel" style="margin-top: var(--spacing-3);">
                  <label class="form-label">Receiver IP:</label>
                  <input type="text" id="receiver-ip" class="form-input" placeholder="192.168.1.100" value="">
                  <button class="btn btn-primary" id="connect-btn">
                      <span>Verbinden</span>
                  </button>
                  <span class="status-indicator status-disconnected" id="connection-status">
                      Getrennt
                  </span>
              </div>
          </div>
      </header>

      <div class="container">
          <!-- Statistics -->
          <div class="stats-grid" id="stats" style="display: none;">
              <div class="stat-card">
                  <div class="stat-value" id="current-volume">-40</div>
                  <div class="stat-label">Lautstärke (dB)</div>
              </div>
              <div class="stat-card">
                  <div class="stat-value" id="current-input">-</div>
                  <div class="stat-label">Aktive Quelle</div>
              </div>
              <div class="stat-card">
                  <div class="stat-value" id="current-dsp">-</div>
                  <div class="stat-label">DSP Modus</div>
              </div>
              <div class="stat-card">
                  <div class="stat-value" id="current-zone">Main</div>
                  <div class="stat-label">Aktive Zone</div>
              </div>
          </div>

          <!-- Main Tabs -->
          <div class="main-tabs" id="main-tabs" style="display: none;">
              <button class="main-tab active" data-tab="basic">Grundsteuerung</button>
              <button class="main-tab" data-tab="extended">Erweiterte Funktionen</button>
              <button class="main-tab" data-tab="system">System Info</button>
          </div>

          <!-- Zone Tabs -->
          <div class="tabs" id="zone-tabs" style="display: none;">
              <button class="tab active" data-zone="Main_Zone">Hauptzone</button>
              <button class="tab" data-zone="Zone_2">Zone 2</button>
          </div>

          <!-- Tab Contents -->
          <div id="controls" style="display: none;">
              <!-- Basic Controls Tab -->
              <div class="tab-content active" id="basic-tab">
              <!-- Basic Controls -->
              <div class="card">
                  <h2>Grundsteuerung</h2>
                  <div class="grid grid-3">
                      <div>
                          <h3>Stromversorgung</h3>
                          <div class="power-button" id="power-btn">
                              <svg viewBox="0 0 24 24">
                                  <path d="M12 2v10m-6.5-5.5C3.5 8.5 2 11 2 14c0 5.5 4.5 10 10 10s10-4.5 10-10c0-3-1.5-5.5-3.5-7.5"/>
                              </svg>
                          </div>
                          <div style="text-align: center;">
                              Status: <span id="power-status">Unbekannt</span>
                          </div>
                      </div>

                      <div>
                          <h3>Lautstärke</h3>
                          <div class="slider-container">
                              <div class="slider-label">
                                  <span>Lautstärke</span>
                                  <span id="volume-value">-40 dB</span>
                              </div>
                              <input type="range" class="slider" id="volume-slider" min="-80" max="-20" value="-40" step="0.5">
                          </div>
                          <div style="display: flex; gap: var(--spacing-2); margin-top: var(--spacing-3);">
                              <button class="btn btn-outline btn-sm" id="vol-down">-</button>
                              <button class="btn btn-outline btn-sm" id="vol-up">+</button>
                          </div>
                          <div class="toggle-container">
                              <div class="toggle-switch" id="mute-toggle"></div>
                              <label class="toggle-label" for="mute-toggle">Stummschaltung</label>
                          </div>
                          <div style="display: flex; align-items: center; gap: var(--spacing-2); margin-top: var(--spacing-3);">
                              <input type="checkbox" id="volume-extended" style="width: 18px; height: 18px;">
                              <label for="volume-extended" style="color: var(--text-light); font-size: 0.9rem; cursor: pointer;">
                                  Volle Lautstärke freischalten (-20 dB bis +16 dB)
                              </label>
                          </div>
                      </div>

                      <div>
                          <h3>Quellenauswahl</h3>
                          <div class="grid grid-2" style="gap: var(--spacing-2);">
                              <button class="btn btn-outline btn-sm" data-input="HDMI1">HDMI 1</button>
                              <button class="btn btn-outline btn-sm" data-input="HDMI2">HDMI 2</button>
                              <button class="btn btn-outline btn-sm" data-input="HDMI3">HDMI 3</button>
                              <button class="btn btn-outline btn-sm" data-input="HDMI4">HDMI 4</button>
                              <button class="btn btn-outline btn-sm" data-input="AV1">AV 1</button>
                              <button class="btn btn-outline btn-sm" data-input="AV2">AV 2</button>
                              <button class="btn btn-outline btn-sm" data-input="AirPlay">AirPlay</button>
                              <button class="btn btn-outline btn-sm" data-input="SERVER">Server</button>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- DSP Controls -->
              <div class="card">
                  <h2>DSP & Surround Sound</h2>
                  <div class="grid grid-2">
                      <div>
                          <h3>DSP Programm</h3>
                          <select class="form-select" id="dsp-mode">
                              <option value="Straight">Straight (Ohne DSP)</option>
                              <option value="Surround Decoder">Surround Decoder</option>
                              <option value="Movie">Movie</option>
                              <option value="Music">Music</option>
                              <option value="Game">Game</option>
                              <option value="Concert Hall">Concert Hall</option>
                              <option value="Jazz Club">Jazz Club</option>
                              <option value="Rock Concert">Rock Concert</option>
                              <option value="Stadium">Stadium</option>
                              <option value="Church">Church</option>
                              <option value="Chamber">Chamber</option>
                              <option value="Drama">Drama</option>
                              <option value="Action Game">Action Game</option>
                              <option value="RPG">RPG</option>
                              <option value="Sports">Sports</option>
                          </select>
                      </div>
                      <div>
                          <h3>Dialogue Level</h3>
                          <div class="slider-container">
                              <div class="slider-label">
                                  <span>Dialog Verstärkung</span>
                                  <span id="dialogue-value">0 dB</span>
                              </div>
                              <input type="range" class="slider" id="dialogue-slider" min="-6" max="6" value="0" step="1">
                          </div>
                      </div>
                  </div>
              </div>

              <!-- Equalizer -->
              <div class="card">
                  <h2>Equalizer</h2>
                  <div class="equalizer">
                      <div class="eq-band">
                          <div class="eq-label">63Hz</div>
                          <input type="range" class="eq-slider" min="-6" max="6" value="0" step="0.5" data-freq="63">
                          <div class="eq-value">0.0dB</div>
                      </div>
                      <div class="eq-band">
                          <div class="eq-label">160Hz</div>
                          <input type="range" class="eq-slider" min="-6" max="6" value="0" step="0.5" data-freq="160">
                          <div class="eq-value">0.0dB</div>
                      </div>
                      <div class="eq-band">
                          <div class="eq-label">400Hz</div>
                          <input type="range" class="eq-slider" min="-6" max="6" value="0" step="0.5" data-freq="400">
                          <div class="eq-value">0.0dB</div>
                      </div>
                      <div class="eq-band">
                          <div class="eq-label">1kHz</div>
                          <input type="range" class="eq-slider" min="-6" max="6" value="0" step="0.5" data-freq="1000">
                          <div class="eq-value">0.0dB</div>
                      </div>
                      <div class="eq-band">
                          <div class="eq-label">2.5kHz</div>
                          <input type="range" class="eq-slider" min="-6" max="6" value="0" step="0.5" data-freq="2500">
                          <div class="eq-value">0.0dB</div>
                      </div>
                      <div class="eq-band">
                          <div class="eq-label">6.3kHz</div>
                          <input type="range" class="eq-slider" min="-6" max="6" value="0" step="0.5" data-freq="6300">
                          <div class="eq-value">0.0dB</div>
                      </div>
                      <div class="eq-band">
                          <div class="eq-label">16kHz</div>
                          <input type="range" class="eq-slider" min="-6" max="6" value="0" step="0.5" data-freq="16000">
                          <div class="eq-value">0.0dB</div>
                      </div>
                  </div>
                  <div style="margin-top: var(--spacing-4); text-align: center;">
                      <button class="btn btn-secondary" id="eq-reset">EQ Zurücksetzen</button>
                  </div>
              </div>

              <!-- Speaker Configuration -->
              <div class="card">
                  <h2>Lautsprecher-Konfiguration</h2>
                  <div class="grid grid-3">
                      <div>
                          <h3>Subwoofer</h3>
                          <div class="stat-card">
                              <div class="stat-value" id="subwoofer-value">0 dB</div>
                              <div class="stat-label">Subwoofer Level (YPAO)</div>
                          </div>
                      </div>
                      <div>
                          <h3>Center Lautsprecher</h3>
                          <div class="stat-card">
                              <div class="stat-value" id="center-value">0 dB</div>
                              <div class="stat-label">Center Level (YPAO)</div>
                          </div>
                      </div>
                      <div>
                          <h3>Surround Level</h3>
                          <div class="stat-card">
                              <div class="stat-value" id="surround-value">0 dB</div>
                              <div class="stat-label">Surround Level (YPAO)</div>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- Audio Settings -->
              <div class="card">
                  <h2>Audio-Einstellungen (Anzeige)</h2>
                  <div class="grid grid-2">
                      <div>
                          <h3>Dynamic Range Control</h3>
                          <div class="stat-card">
                              <div class="stat-value" id="drc-value">Aus</div>
                              <div class="stat-label">DRC Status (YPAO)</div>
                          </div>
                      </div>
                      <div>
                          <h3>Lip Sync Delay</h3>
                          <div class="stat-card">
                              <div class="stat-value" id="lipsync-value">0 ms</div>
                              <div class="stat-label">Audio Delay (YPAO)</div>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- Scene Controls -->
              <div class="card">
                  <h2>Szenen-Steuerung</h2>
                  <div class="grid grid-4">
                      <button class="btn btn-outline" data-scene="1">
                          <span>Szene 1</span>
                      </button>
                      <button class="btn btn-outline" data-scene="2">
                          <span>Szene 2</span>
                      </button>
                      <button class="btn btn-outline" data-scene="3">
                          <span>Szene 3</span>
                      </button>
                      <button class="btn btn-outline" data-scene="4">
                          <span>Szene 4</span>
                      </button>
                  </div>
              </div>

              <!-- HDMI Settings -->
              <div class="card">
                  <h2>HDMI-Einstellungen</h2>
                  <div class="grid grid-2">
                      <div>
                          <h3>HDMI Audio Format</h3>
                          <select class="form-select" id="hdmi-audio-format">
                              <option value="PCM">PCM</option>
                              <option value="DTS">DTS</option>
                              <option value="Dolby Digital">Dolby Digital</option>
                              <option value="Bitstream">Bitstream</option>
                          </select>
                      </div>
                      <div>
                          <h3>HDMI Control</h3>
                          <select class="form-select" id="hdmi-control">
                              <option value="Off">Aus</option>
                              <option value="On">Ein</option>
                          </select>
                      </div>
                  </div>
              </div>
              </div> <!-- End basic-tab -->

              <!-- Extended Functions Tab -->
              <div class="tab-content" id="extended-tab">
                  <!-- Audio Enhancement -->
                  <div class="card">
                      <h2>Audio Enhancement</h2>
                      <div class="grid grid-2">
                          <div class="toggle-container">
                              <div class="toggle-switch" id="extra-bass-toggle"></div>
                              <label class="toggle-label">Extra Bass</label>
                          </div>
                          <div>
                              <h3>Bass Control</h3>
                              <div class="slider-container">
                                  <div class="slider-label">
                                      <span>Bass</span>
                                      <span id="bass-value">0 dB</span>
                                  </div>
                                  <input type="range" class="slider" id="bass-slider" min="-6" max="6" value="0" step="0.5">
                              </div>
                          </div>
                          <div>
                              <h3>Treble Control</h3>
                              <div class="slider-container">
                                  <div class="slider-label">
                                      <span>Treble</span>
                                      <span id="treble-value">0 dB</span>
                                  </div>
                                  <input type="range" class="slider" id="treble-slider" min="-6" max="6" value="0" step="0.5">
                              </div>
                          </div>
                          <div class="toggle-container">
                              <div class="toggle-switch" id="music-enhancer-toggle"></div>
                              <label class="toggle-label">Compressed Music Enhancer</label>
                          </div>
                          <div class="toggle-container">
                              <div class="toggle-switch" id="pure-direct-toggle"></div>
                              <label class="toggle-label">Pure Direct Mode</label>
                          </div>
                          <div class="toggle-container">
                              <div class="toggle-switch" id="straight-mode-toggle"></div>
                              <label class="toggle-label">Straight Mode</label>
                          </div>
                          <div class="toggle-container">
                              <div class="toggle-switch" id="vps-toggle"></div>
                              <label class="toggle-label">Virtual Presence Speaker (VPS)</label>
                          </div>
                      </div>
                  </div>

                  <!-- System Settings -->
                  <div class="card">
                      <h2>Sleep Timer</h2>
                      <div class="grid grid-2">
                          <div>
                              <h3>Ausschalten nach</h3>
                              <select class="form-select" id="sleep-timer">
                                  <option value="0">Aus</option>
                                  <option value="30">30 Minuten</option>
                                  <option value="60">60 Minuten</option>
                                  <option value="90">90 Minuten</option>
                                  <option value="120">120 Minuten</option>
                              </select>
                          </div>
                      </div>
                  </div>

                  <!-- Quick Setup Presets -->
                  <div class="card">
                      <h2>Quick Setup Presets</h2>
                      <div class="grid grid-3">
                          <button class="btn btn-primary" id="preset-movie">
                              🎬 Movie Mode
                          </button>
                          <button class="btn btn-primary" id="preset-music">
                              🎵 Music Mode
                          </button>
                          <button class="btn btn-primary" id="preset-gaming">
                              🎮 Gaming Mode
                          </button>
                      </div>
                      <div class="grid grid-2" style="margin-top: var(--spacing-4);">
                          <button class="btn btn-secondary" id="save-preset">
                              💾 Preset speichern
                          </button>
                          <button class="btn btn-secondary" id="load-preset">
                              📂 Preset laden
                          </button>
                      </div>
                  </div>
              </div>

              <!-- System Info Tab -->
              <div class="tab-content" id="system-tab">
                  <!-- System Status -->
                  <div class="card">
                      <h2>System Status</h2>
                      <div class="grid grid-2">
                          <div class="stat-card">
                              <div class="stat-value" id="firmware-version">-</div>
                              <div class="stat-label">Firmware Version</div>
                          </div>
                          <div class="stat-card">
                              <div class="stat-value" id="device-temp">-</div>
                              <div class="stat-label">Geräteinnentemperatur</div>
                          </div>
                          <div class="stat-card">
                              <div class="stat-value" id="signal-format">-</div>
                              <div class="stat-label">Input Signal Format</div>
                          </div>
                          <div class="stat-card">
                              <div class="stat-value" id="signal-channels">-</div>
                              <div class="stat-label">Kanäle</div>
                          </div>
                      </div>
                  </div>

                  <!-- Network Information -->
                  <div class="card">
                      <h2>Netzwerk Information</h2>
                      <div class="grid grid-2">
                          <div class="stat-card">
                              <div class="stat-value" id="network-ip">-</div>
                              <div class="stat-label">IP-Adresse</div>
                          </div>
                          <div class="stat-card">
                              <div class="stat-value" id="network-mac">-</div>
                              <div class="stat-label">MAC-Adresse</div>
                          </div>
                          <div class="stat-card">
                              <div class="stat-value" id="network-gateway">-</div>
                              <div class="stat-label">Gateway</div>
                          </div>
                          <div class="stat-card">
                              <div class="stat-value" id="network-signal">-</div>
                              <div class="stat-label">Signalstärke</div>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <div class="message" id="message"></div>

      <script>
          class YamahaAdvancedReceiver {
              constructor() {
                  this.ip = '';
                  this.currentZone = 'Main_Zone';
                  this.connected = false;
                  this.statusInterval = null;
                  this.initializeElements();
                  this.attachEventListeners();
                  this.loadSavedIP();
              }

              initializeElements() {
                  this.elements = {
                      // Connection
                      ipInput: document.getElementById('receiver-ip'),
                      connectBtn: document.getElementById('connect-btn'),
                      connectionStatus: document.getElementById('connection-status'),
                      toggleConnection: document.getElementById('toggle-connection'),
                      toggleIcon: document.getElementById('toggle-icon'),
                      connectionPanel: document.getElementById('connection-panel'),

                      // UI Sections
                      stats: document.getElementById('stats'),
                      mainTabs: document.getElementById('main-tabs'),
                      zoneTabs: document.getElementById('zone-tabs'),
                      controls: document.getElementById('controls'),

                      // Basic Controls
                      powerBtn: document.getElementById('power-btn'),
                      powerStatus: document.getElementById('power-status'),
                      volumeSlider: document.getElementById('volume-slider'),
                      volumeValue: document.getElementById('volume-value'),
                      volumeExtended: document.getElementById('volume-extended'),
                      volUpBtn: document.getElementById('vol-up'),
                      volDownBtn: document.getElementById('vol-down'),
                      muteToggle: document.getElementById('mute-toggle'),

                      // Statistics
                      currentVolume: document.getElementById('current-volume'),
                      currentInput: document.getElementById('current-input'),
                      currentDsp: document.getElementById('current-dsp'),
                      currentZone: document.getElementById('current-zone'),

                      // DSP Controls
                      dspMode: document.getElementById('dsp-mode'),
                      dialogueSlider: document.getElementById('dialogue-slider'),
                      dialogueValue: document.getElementById('dialogue-value'),

                      // Equalizer
                      eqSliders: document.querySelectorAll('.eq-slider'),
                      eqReset: document.getElementById('eq-reset'),

                      // Speaker Configuration (Display Only)
                      subwooferValue: document.getElementById('subwoofer-value'),
                      centerValue: document.getElementById('center-value'),
                      surroundValue: document.getElementById('surround-value'),

                      // Audio Settings (Display Only)
                      drcValue: document.getElementById('drc-value'),
                      lipsyncValue: document.getElementById('lipsync-value'),

                      // HDMI Settings
                      hdmiAudioFormat: document.getElementById('hdmi-audio-format'),
                      hdmiControl: document.getElementById('hdmi-control'),

                      // Extended Functions
                      extraBassToggle: document.getElementById('extra-bass-toggle'),
                      bassSlider: document.getElementById('bass-slider'),
                      bassValue: document.getElementById('bass-value'),
                      trebleSlider: document.getElementById('treble-slider'),
                      trebleValue: document.getElementById('treble-value'),
                      musicEnhancerToggle: document.getElementById('music-enhancer-toggle'),
                      pureDirectToggle: document.getElementById('pure-direct-toggle'),
                      straightModeToggle: document.getElementById('straight-mode-toggle'),
                      vpsToggle: document.getElementById('vps-toggle'),
                      sleepTimer: document.getElementById('sleep-timer'),
                      presetMovie: document.getElementById('preset-movie'),
                      presetMusic: document.getElementById('preset-music'),
                      presetGaming: document.getElementById('preset-gaming'),
                      savePreset: document.getElementById('save-preset'),
                      loadPreset: document.getElementById('load-preset'),

                      // System Info Elements
                      firmwareVersion: document.getElementById('firmware-version'),
                      deviceTemp: document.getElementById('device-temp'),
                      signalFormat: document.getElementById('signal-format'),
                      signalChannels: document.getElementById('signal-channels'),
                      networkIp: document.getElementById('network-ip'),
                      networkMac: document.getElementById('network-mac'),
                      networkGateway: document.getElementById('network-gateway'),
                      networkSignal: document.getElementById('network-signal'),

                      // Controls
                      message: document.getElementById('message'),
                      mainTabBtns: document.querySelectorAll('.main-tab'),
                      tabContents: document.querySelectorAll('.tab-content'),
                      tabs: document.querySelectorAll('.tab'),
                      inputBtns: document.querySelectorAll('[data-input]'),
                      sceneBtns: document.querySelectorAll('[data-scene]')
                  };
              }

              attachEventListeners() {
                  // Connection
                  this.elements.connectBtn.addEventListener('click', () => this.connect());
                  this.elements.ipInput.addEventListener('keypress', (e) => {
                      if (e.key === 'Enter') this.connect();
                  });
                  
                  // Toggle connection panel
                  this.elements.toggleConnection.addEventListener('click', () => {
                      this.elements.connectionPanel.classList.toggle('collapsed');
                      this.elements.toggleIcon.classList.toggle('collapsed');
                  });

                  // Basic Controls
                  this.elements.powerBtn.addEventListener('click', () => this.togglePower());

                  this.elements.volumeSlider.addEventListener('input', (e) => {
                      this.updateVolumeDisplay(e.target.value);
                  });

                  this.elements.volumeSlider.addEventListener('change', (e) => {
                      this.setVolume(e.target.value);
                  });

                  this.elements.volUpBtn.addEventListener('click', () => this.adjustVolume(0.5));
                  this.elements.volDownBtn.addEventListener('click', () => this.adjustVolume(-0.5));
                  this.elements.muteToggle.addEventListener('click', () => this.toggleMute());
                  
                  // Volume extended checkbox
                  this.elements.volumeExtended.addEventListener('change', (e) => {
                      const isExtended = e.target.checked;
                      const currentValue = parseFloat(this.elements.volumeSlider.value);
                      
                      if (isExtended) {
                          // Extended range: -80 to +16
                          this.elements.volumeSlider.max = '16';
                      } else {
                          // Limited range: -80 to -20
                          this.elements.volumeSlider.max = '-20';
                          // If current value is above -20, set it to -20
                          if (currentValue > -20) {
                              this.elements.volumeSlider.value = '-20';
                              this.setVolume(-20);
                          }
                      }
                  });

                  // Zone Tabs
                  this.elements.tabs.forEach(tab => {
                      tab.addEventListener('click', (e) => this.switchZone(e.target.dataset.zone));
                  });

                  // Input Selection
                  this.elements.inputBtns.forEach(btn => {
                      btn.addEventListener('click', (e) => this.selectInput(e.target.dataset.input));
                  });

                  // Scene Selection
                  this.elements.sceneBtns.forEach(btn => {
                      btn.addEventListener('click', (e) => this.selectScene(e.target.dataset.scene));
                  });

                  // DSP Controls
                  this.elements.dspMode.addEventListener('change', (e) => this.setDSPMode(e.target.value));

                  this.elements.dialogueSlider.addEventListener('input', (e) => {
                      this.elements.dialogueValue.textContent = `${e.target.value} dB`;
                  });
                  this.elements.dialogueSlider.addEventListener('change', (e) => {
                      this.setDialogueLevel(e.target.value);
                  });

                  // Equalizer
                  this.elements.eqSliders.forEach(slider => {
                      slider.addEventListener('input', (e) => {
                          const band = e.target.closest('.eq-band');
                          const valueElement = band.querySelector('.eq-value');
                          valueElement.textContent = `${parseFloat(e.target.value).toFixed(1)}dB`;
                      });

                      slider.addEventListener('change', (e) => {
                          this.setEQBand(e.target.dataset.freq, e.target.value);
                      });
                  });

                  this.elements.eqReset.addEventListener('click', () => this.resetEqualizer());

                  // Speaker Configuration and Audio Settings are now display-only (YPAO controlled)

                  // HDMI Settings
                  this.elements.hdmiAudioFormat.addEventListener('change', (e) => this.setHDMIAudioFormat(e.target.value));
                  this.elements.hdmiControl.addEventListener('change', (e) => this.setHDMIControl(e.target.value));

                  // Main Tab Navigation
                  this.elements.mainTabBtns.forEach(tab => {
                      tab.addEventListener('click', (e) => this.switchMainTab(e.target.dataset.tab));
                  });

                  // Extended Functions
                  this.elements.extraBassToggle.addEventListener('click', () => this.toggleExtraBass());
                  
                  // Bass/Treble Controls
                  this.elements.bassSlider.addEventListener('input', (e) => {
                      this.elements.bassValue.textContent = `${e.target.value} dB`;
                  });
                  this.elements.bassSlider.addEventListener('change', (e) => {
                      this.setBassLevel(e.target.value);
                  });
                  
                  this.elements.trebleSlider.addEventListener('input', (e) => {
                      this.elements.trebleValue.textContent = `${e.target.value} dB`;
                  });
                  this.elements.trebleSlider.addEventListener('change', (e) => {
                      this.setTrebleLevel(e.target.value);
                  });
                  
                  this.elements.musicEnhancerToggle.addEventListener('click', () => this.toggleMusicEnhancer());
                  this.elements.pureDirectToggle.addEventListener('click', () => this.togglePureDirect());
                  this.elements.straightModeToggle.addEventListener('click', () => this.toggleStraightMode());
                  this.elements.vpsToggle.addEventListener('click', () => this.toggleVPS());
                  this.elements.sleepTimer.addEventListener('change', (e) => this.setSleepTimer(e.target.value));

                  // Presets
                  this.elements.presetMovie.addEventListener('click', () => this.loadQuickPreset('movie'));
                  this.elements.presetMusic.addEventListener('click', () => this.loadQuickPreset('music'));
                  this.elements.presetGaming.addEventListener('click', () => this.loadQuickPreset('gaming'));
                  this.elements.savePreset.addEventListener('click', () => this.saveCurrentPreset());
                  this.elements.loadPreset.addEventListener('click', () => this.loadUserPreset());
              }

              async loadSavedIP() {
                  try {
                      // First check server for saved IP
                      const response = await fetch('/api/health');
                      const data = await response.json();
                      
                      if (data.receiverIP) {
                          this.elements.ipInput.value = data.receiverIP;
                          // Collapse connection panel when IP is saved
                          this.elements.connectionPanel.classList.add('collapsed');
                          this.elements.toggleIcon.classList.add('collapsed');
                          // Auto-connect if IP is saved on server
                          setTimeout(() => this.connect(), 1000);
                          return;
                      }
                  } catch (error) {
                      console.log('No saved IP on server, checking localStorage');
                  }
                  
                  // Fallback to localStorage
                  const savedIP = localStorage.getItem('yamaha-receiver-ip');
                  if (savedIP) {
                      this.elements.ipInput.value = savedIP;
                      // Collapse connection panel when IP is saved
                      this.elements.connectionPanel.classList.add('collapsed');
                      this.elements.toggleIcon.classList.add('collapsed');
                  }
              }

              async connect() {
                  const ip = this.elements.ipInput.value.trim();
                  if (!ip) {
                      this.showMessage('Bitte geben Sie die Receiver IP-Adresse ein', 'error');
                      return;
                  }

                  this.ip = ip;
                  localStorage.setItem('yamaha-receiver-ip', ip);

                  this.elements.connectBtn.disabled = true;
                  this.elements.connectBtn.innerHTML = '<div class="loading"></div><span>Verbinde...</span>';

                  try {
                      await this.setReceiverIP(ip);
                      await this.getStatus(true);

                      this.connected = true;
                      this.elements.connectionStatus.className = 'status-indicator status-connected';
                      this.elements.connectionStatus.textContent = 'Verbunden';

                      this.elements.stats.style.display = 'grid';
                      this.elements.mainTabs.style.display = 'flex';
                      this.elements.zoneTabs.style.display = 'flex';
                      this.elements.controls.style.display = 'block';

                      this.showMessage('Erfolgreich verbunden', 'success');
                      this.startStatusPolling();

                  } catch (error) {
                      this.connected = false;
                      this.elements.connectionStatus.className = 'status-indicator status-disconnected';
                      this.elements.connectionStatus.textContent = 'Verbindung fehlgeschlagen';

                      this.elements.stats.style.display = 'none';
                      this.elements.mainTabs.style.display = 'none';
                      this.elements.zoneTabs.style.display = 'none';
                      this.elements.controls.style.display = 'none';

                      this.showMessage('Verbindung fehlgeschlagen: ' + error.message, 'error');
                  } finally {
                      this.elements.connectBtn.disabled = false;
                      this.elements.connectBtn.innerHTML = '<span>Verbinden</span>';
                  }
              }

              async setReceiverIP(ip) {
                  const response = await fetch('/api/set-receiver-ip', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ ip })
                  });

                  if (!response.ok) {
                      const error = await response.json();
                      throw new Error(error.error || 'Failed to set receiver IP');
                  }

                  return response.json();
              }

              async sendCommand(xml, isConnectionAttempt = false) {
                  if (!this.connected && !isConnectionAttempt) {
                      throw new Error('Nicht mit Receiver verbunden');
                  }

                  const url = '/api/receiver/YamahaRemoteControl/ctrl';

                  try {
                      const response = await fetch(url, {
                          method: 'POST',
                          headers: { 'Content-Type': 'text/xml' },
                          body: xml
                      });

                      if (!response.ok) {
                          throw new Error(`HTTP error! status: ${response.status}`);
                      }

                      const text = await response.text();
                      return this.parseXML(text);
                  } catch (error) {
                      if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                          throw new Error('Netzwerkfehler - Server läuft nicht');
                      }
                      throw error;
                  }
              }

              parseXML(xmlString) {
                  const parser = new DOMParser();
                  return parser.parseFromString(xmlString, 'text/xml');
              }

              async getStatus(isConnectionAttempt = false) {
                  const xml = `<YAMAHA_AV cmd="GET"><${this.currentZone}><Basic_Status>GetParam</Basic_Status></${this.currentZone}></YAMAHA_AV>`;
                  const response = await this.sendCommand(xml, isConnectionAttempt);

                  const power = response.querySelector('Power')?.textContent;
                  const volume = response.querySelector('Volume Lvl Val')?.textContent;
                  const mute = response.querySelector('Mute')?.textContent;
                  const input = response.querySelector('Input Input_Sel')?.textContent;

                  this.updateUI({ power, volume, mute, input });
              }

              updateUI({ power, volume, mute, input }) {
                  if (power) {
                      const isOn = power === 'On';
                      this.elements.powerBtn.classList.toggle('on', isOn);
                      this.elements.powerStatus.textContent = isOn ? 'Ein' : 'Standby';
                  }

                  if (volume) {
                      const vol = parseInt(volume) / 10;
                      const isExtended = this.elements.volumeExtended.checked;
                      const maxSliderValue = isExtended ? 16 : -20;
                      
                      // Only update slider if volume is within current slider range
                      if (vol >= -80 && vol <= maxSliderValue) {
                          this.elements.volumeSlider.value = vol;
                      }
                      this.updateVolumeDisplay(vol);
                      this.elements.currentVolume.textContent = vol;
                  }

                  if (mute) {
                      this.elements.muteToggle.classList.toggle('active', mute === 'On');
                  }

                  if (input) {
                      this.elements.inputBtns.forEach(btn => {
                          const isActive = btn.dataset.input === input;
                          btn.classList.toggle('btn-primary', isActive);
                          btn.classList.toggle('btn-outline', !isActive);
                      });
                      this.elements.currentInput.textContent = input;
                  }
              }

              updateVolumeDisplay(value) {
                  this.elements.volumeValue.textContent = `${value} dB`;
                  this.elements.currentVolume.textContent = value;
              }

              adjustVolume(change) {
                  // Get current volume from display (which shows the true volume)
                  const current = parseFloat(this.elements.currentVolume.textContent);
                  const newVal = Math.max(-80, Math.min(16, current + change));
                  const isExtended = this.elements.volumeExtended.checked;
                  const maxSliderValue = isExtended ? 16 : -20;
                  
                  // Update slider only if within current slider range
                  if (newVal >= -80 && newVal <= maxSliderValue) {
                      this.elements.volumeSlider.value = newVal;
                  }
                  
                  this.setVolume(newVal);
              }

              async togglePower() {
                  const isOn = this.elements.powerBtn.classList.contains('on');
                  const newState = isOn ? 'Standby' : 'On';
                  const xml = `<YAMAHA_AV cmd="PUT"><${this.currentZone}><Power_Control><Power>${newState}</Power></Power_Control></${this.currentZone}></YAMAHA_AV>`;

                  try {
                      await this.sendCommand(xml);
                      this.showMessage(`Strom ${newState === 'On' ? 'Ein' : 'Aus'}`, 'success');
                      setTimeout(() => this.getStatus(), 500);
                  } catch (error) {
                      this.showMessage('Fehler beim Umschalten: ' + error.message, 'error');
                  }
              }

              async setVolume(value) {
                  const volValue = Math.round(value * 10);
                  const xml = `<YAMAHA_AV cmd="PUT"><${this.currentZone}><Volume><Lvl><Val>${volValue}</Val><Exp>1</Exp><Unit>dB</Unit></Lvl></Volume></${this.currentZone}></YAMAHA_AV>`;

                  try {
                      await this.sendCommand(xml);
                      this.updateVolumeDisplay(value);
                  } catch (error) {
                      this.showMessage('Fehler beim Setzen der Lautstärke: ' + error.message, 'error');
                  }
              }

              async toggleMute() {
                  const isMuted = this.elements.muteToggle.classList.contains('active');
                  const newState = isMuted ? 'Off' : 'On';
                  const xml = `<YAMAHA_AV cmd="PUT"><${this.currentZone}><Volume><Mute>${newState}</Mute></Volume></${this.currentZone}></YAMAHA_AV>`;

                  try {
                      await this.sendCommand(xml);
                      this.elements.muteToggle.classList.toggle('active');
                      this.showMessage(`Ton ${newState === 'On' ? 'deaktiviert' : 'aktiviert'}`, 'success');
                  } catch (error) {
                      this.showMessage('Fehler beim Stummschalten: ' + error.message, 'error');
                  }
              }

              async selectInput(input) {
                  const xml = `<YAMAHA_AV cmd="PUT"><${this.currentZone}><Input><Input_Sel>${input}</Input_Sel></Input></${this.currentZone}></YAMAHA_AV>`;

                  try {
                      await this.sendCommand(xml);
                      this.showMessage(`Quelle gewechselt zu ${input}`, 'success');
                      setTimeout(() => this.getStatus(), 500);
                  } catch (error) {
                      this.showMessage('Fehler beim Wechseln der Quelle: ' + error.message, 'error');
                  }
              }

              async selectScene(scene) {
                  const xml = `<YAMAHA_AV cmd="PUT"><${this.currentZone}><Scene><Scene_Sel>Scene ${scene}</Scene_Sel></Scene></${this.currentZone}></YAMAHA_AV>`;

                  try {
                      await this.sendCommand(xml);
                      this.showMessage(`Szene ${scene} aktiviert`, 'success');
                  } catch (error) {
                      this.showMessage('Fehler beim Aktivieren der Szene: ' + error.message, 'error');
                  }
              }

              async setDSPMode(mode) {
                  const xml = `<YAMAHA_AV
  cmd="PUT"><${this.currentZone}><Surround><Program_Sel><Current><Sound_Program>${mode}</Sound_Program></Current></Program_Sel></Surround></${this.currentZone}></YAMAHA_AV>`;

                  try {
                      await this.sendCommand(xml);
                      this.elements.currentDsp.textContent = mode;
                      this.showMessage(`DSP Modus: ${mode}`, 'success');
                  } catch (error) {
                      this.showMessage('Fehler beim Setzen des DSP Modus: ' + error.message, 'error');
                  }
              }

              async setDialogueLevel(level) {
                  const xml = `<YAMAHA_AV cmd="PUT"><${this.currentZone}><Surround><Program_Sel><Current><DSP_Parameter><Dialogue_Level><Val>${level}</Val></Dialogue_Level></DSP_Parameter></Current></Program_Sel>
  </Surround></${this.currentZone}></YAMAHA_AV>`;

                  try {
                      await this.sendCommand(xml);
                      this.showMessage(`Dialog Level: ${level} dB`, 'success');
                  } catch (error) {
                      this.showMessage('Fehler beim Setzen des Dialog Levels: ' + error.message, 'error');
                  }
              }

              async setEQBand(frequency, value) {
                  try {
                      this.showMessage(`EQ ${frequency}Hz: ${value} dB`, 'info');
                  } catch (error) {
                      this.showMessage('Fehler beim Setzen des Equalizers: ' + error.message, 'error');
                  }
              }

              resetEqualizer() {
                  this.elements.eqSliders.forEach(slider => {
                      slider.value = 0;
                      const band = slider.closest('.eq-band');
                      const valueElement = band.querySelector('.eq-value');
                      valueElement.textContent = '0.0dB';
                  });
                  this.showMessage('Equalizer zurückgesetzt', 'success');
              }

              // Bass and Treble Controls
              async setBassLevel(level) {
                  const bassValue = Math.round(level * 10);
                  const xml = `<YAMAHA_AV cmd="PUT"><${this.currentZone}><Sound_Video><Tone><Bass><Val>${bassValue}</Val><Exp>1</Exp><Unit>dB</Unit></Bass></Tone></Sound_Video></${this.currentZone}></YAMAHA_AV>`;

                  try {
                      await this.sendCommand(xml);
                      this.showMessage(`Bass Level: ${level} dB`, 'success');
                  } catch (error) {
                      this.showMessage('Fehler beim Setzen des Bass Levels: ' + error.message, 'error');
                  }
              }

              async setTrebleLevel(level) {
                  const trebleValue = Math.round(level * 10);
                  const xml = `<YAMAHA_AV cmd="PUT"><${this.currentZone}><Sound_Video><Tone><Treble><Val>${trebleValue}</Val><Exp>1</Exp><Unit>dB</Unit></Treble></Tone></Sound_Video></${this.currentZone}></YAMAHA_AV>`;

                  try {
                      await this.sendCommand(xml);
                      this.showMessage(`Treble Level: ${level} dB`, 'success');
                  } catch (error) {
                      this.showMessage('Fehler beim Setzen des Treble Levels: ' + error.message, 'error');
                  }
              }

              async setSubwooferLevel(level) {
                  const xml = `<YAMAHA_AV cmd="PUT"><${this.currentZone}><Volume><Subwoofer><Lvl><Val>${Math.round(level *
  10)}</Val><Exp>1</Exp><Unit>dB</Unit></Lvl></Subwoofer></Volume></${this.currentZone}></YAMAHA_AV>`;

                  try {
                      await this.sendCommand(xml);
                      this.showMessage(`Subwoofer Level: ${level} dB`, 'success');
                  } catch (error) {
                      this.showMessage('Fehler beim Setzen des Subwoofer Levels: ' + error.message, 'error');
                  }
              }

              async setCenterLevel(level) {
                  const xml = `<YAMAHA_AV cmd="PUT"><${this.currentZone}><Volume><Center><Lvl><Val>${Math.round(level *
  10)}</Val><Exp>1</Exp><Unit>dB</Unit></Lvl></Center></Volume></${this.currentZone}></YAMAHA_AV>`;

                  try {
                      await this.sendCommand(xml);
                      this.showMessage(`Center Level: ${level} dB`, 'success');
                  } catch (error) {
                      this.showMessage('Fehler beim Setzen des Center Levels: ' + error.message, 'error');
                  }
              }

              async setSurroundLevel(level) {
                  const xml = `<YAMAHA_AV cmd="PUT"><${this.currentZone}><Volume><Surround_L><Lvl><Val>${Math.round(level *
  10)}</Val><Exp>1</Exp><Unit>dB</Unit></Lvl></Surround_L></Volume></${this.currentZone}></YAMAHA_AV>`;

                  try {
                      await this.sendCommand(xml);
                      this.showMessage(`Surround Level: ${level} dB`, 'success');
                  } catch (error) {
                      this.showMessage('Fehler beim Setzen des Surround Levels: ' + error.message, 'error');
                  }
              }

              async setDRC(mode) {
                  const xml = `<YAMAHA_AV cmd="PUT"><${this.currentZone}><Sound_Video><YPAO><VOL><Adaptive_DRC>${mode}</Adaptive_DRC></VOL></YPAO></Sound_Video></${this.currentZone}></YAMAHA_AV>`;

                  try {
                      await this.sendCommand(xml);
                      this.showMessage(`DRC: ${mode}`, 'success');
                  } catch (error) {
                      this.showMessage('Fehler beim Setzen des DRC: ' + error.message, 'error');
                  }
              }

              async setLipSync(delay) {
                  const xml = `<YAMAHA_AV cmd="PUT"><${this.currentZone}><Sound_Video><YPAO><Audio_Delay><Val>${delay}</Val><Unit>ms</Unit></Audio_Delay></YPAO></Sound_Video></${this.currentZone}></YAMAHA_AV>`;

                  try {
                      await this.sendCommand(xml);
                      this.showMessage(`Lip Sync Delay: ${delay} ms`, 'success');
                  } catch (error) {
                      this.showMessage('Fehler beim Setzen des Audio Delays: ' + error.message, 'error');
                  }
              }

              async setHDMIAudioFormat(format) {
                  try {
                      this.showMessage(`HDMI Audio Format: ${format}`, 'info');
                  } catch (error) {
                      this.showMessage('Fehler beim Setzen des HDMI Audio Formats: ' + error.message, 'error');
                  }
              }

              async setHDMIControl(control) {
                  try {
                      this.showMessage(`HDMI Control: ${control}`, 'info');
                  } catch (error) {
                      this.showMessage('Fehler beim Setzen der HDMI Kontrolle: ' + error.message, 'error');
                  }
              }

              switchZone(zone) {
                  this.currentZone = zone;
                  this.elements.tabs.forEach(tab => {
                      tab.classList.toggle('active', tab.dataset.zone === zone);
                  });

                  this.elements.currentZone.textContent = zone === 'Main_Zone' ? 'Main' : 'Zone 2';

                  if (this.connected) {
                      this.getStatus();
                  }
              }

              startStatusPolling() {
                  if (this.statusInterval) {
                      clearInterval(this.statusInterval);
                  }

                  this.statusInterval = setInterval(() => {
                      if (this.connected) {
                          this.getStatus().catch(error => {
                              console.error('Status polling error:', error);
                          });
                      }
                  }, 5000);
              }

              showMessage(text, type = 'info') {
                  this.elements.message.textContent = text;
                  this.elements.message.className = `message ${type} show`;

                  setTimeout(() => {
                      this.elements.message.classList.remove('show');
                  }, 3000);
              }

              // Main Tab Navigation
              switchMainTab(tabName) {
                  // Update tab buttons
                  this.elements.mainTabBtns.forEach(tab => {
                      tab.classList.toggle('active', tab.dataset.tab === tabName);
                  });

                  // Update tab content
                  this.elements.tabContents.forEach(content => {
                      content.classList.toggle('active', content.id === `${tabName}-tab`);
                  });

                  // Load system info when switching to system tab
                  if (tabName === 'system') {
                      this.loadSystemInfo();
                  }
              }

              // Extended Functions
              async toggleExtraBass() {
                  const isActive = this.elements.extraBassToggle.classList.contains('active');
                  const newState = isActive ? 'Off' : 'On';
                  const xml = `<YAMAHA_AV cmd="PUT"><${this.currentZone}><Sound_Video><Extra_Bass>${newState}</Extra_Bass></Sound_Video></${this.currentZone}></YAMAHA_AV>`;

                  try {
                      await this.sendCommand(xml);
                      this.elements.extraBassToggle.classList.toggle('active');
                      this.showMessage(`Extra Bass ${newState === 'On' ? 'aktiviert' : 'deaktiviert'}`, 'success');
                  } catch (error) {
                      this.showMessage('Fehler beim Setzen des Extra Bass: ' + error.message, 'error');
                  }
              }

              async toggleMusicEnhancer() {
                  const isActive = this.elements.musicEnhancerToggle.classList.contains('active');
                  const newState = isActive ? 'Off' : 'On';
                  const xml = `<YAMAHA_AV cmd="PUT"><${this.currentZone}><Sound_Video><YPAO><VOL><Adaptive_DRC>${newState}</Adaptive_DRC></VOL></YPAO></Sound_Video></${this.currentZone}></YAMAHA_AV>`;

                  try {
                      await this.sendCommand(xml);
                      this.elements.musicEnhancerToggle.classList.toggle('active');
                      this.showMessage(`Music Enhancer ${newState === 'On' ? 'aktiviert' : 'deaktiviert'}`, 'success');
                  } catch (error) {
                      this.showMessage('Fehler beim Setzen des Music Enhancer: ' + error.message, 'error');
                  }
              }

              async togglePureDirect() {
                  const isActive = this.elements.pureDirectToggle.classList.contains('active');
                  const newState = isActive ? 'Off' : 'On';
                  const xml = `<YAMAHA_AV cmd="PUT"><${this.currentZone}><Sound_Video><Direct><Mode>${newState}</Mode></Direct></Sound_Video></${this.currentZone}></YAMAHA_AV>`;

                  try {
                      await this.sendCommand(xml);
                      this.elements.pureDirectToggle.classList.toggle('active');
                      this.showMessage(`Pure Direct ${newState === 'On' ? 'aktiviert' : 'deaktiviert'}`, 'success');
                  } catch (error) {
                      this.showMessage('Fehler beim Setzen des Pure Direct: ' + error.message, 'error');
                  }
              }

              async toggleStraightMode() {
                  const isActive = this.elements.straightModeToggle.classList.contains('active');
                  const newState = isActive ? 'Off' : 'On';
                  const xml = `<YAMAHA_AV cmd="PUT"><${this.currentZone}><Surround><Program_Sel><Current><Straight>${newState}</Straight></Current></Program_Sel></Surround></${this.currentZone}></YAMAHA_AV>`;

                  try {
                      await this.sendCommand(xml);
                      this.elements.straightModeToggle.classList.toggle('active');
                      this.showMessage(`Straight Mode ${newState === 'On' ? 'aktiviert' : 'deaktiviert'}`, 'success');
                  } catch (error) {
                      this.showMessage('Fehler beim Setzen des Straight Mode: ' + error.message, 'error');
                  }
              }

              async toggleVPS() {
                  const isActive = this.elements.vpsToggle.classList.contains('active');
                  // VPS is activated by selecting a Cinema DSP program
                  const program = isActive ? 'Straight' : 'Movie';
                  const xml = `<YAMAHA_AV cmd="PUT"><${this.currentZone}><Surround><Program_Sel><Current><Sound_Program>${program}</Sound_Program></Current></Program_Sel></Surround></${this.currentZone}></YAMAHA_AV>`;

                  try {
                      await this.sendCommand(xml);
                      this.elements.vpsToggle.classList.toggle('active');
                      this.showMessage(`VPS ${isActive ? 'deaktiviert' : 'aktiviert'}`, 'success');
                  } catch (error) {
                      this.showMessage('Fehler beim Setzen des VPS: ' + error.message, 'error');
                  }
              }




              async setSleepTimer(minutes) {
                  const sleepValue = minutes === '0' ? 'Off' : `${minutes} min`;
                  const xml = `<YAMAHA_AV cmd="PUT"><${this.currentZone}><Power_Control><Sleep>${sleepValue}</Sleep></Power_Control></${this.currentZone}></YAMAHA_AV>`;

                  try {
                      await this.sendCommand(xml);
                      this.showMessage(`Sleep Timer: ${sleepValue}`, 'success');
                  } catch (error) {
                      this.showMessage('Fehler beim Setzen des Sleep Timers: ' + error.message, 'error');
                  }
              }

              // Quick Presets
              loadQuickPreset(preset) {
                  const presets = {
                      movie: {
                          dsp: 'Movie',
                          dialogue: 3,
                          bass: 2,
                          enhancer: 'Off'
                      },
                      music: {
                          dsp: 'Hall in Munich',
                          dialogue: 0,
                          bass: -1,
                          enhancer: 'On'
                      },
                      gaming: {
                          dsp: 'Sci-Fi',
                          dialogue: 6,
                          bass: 4,
                          enhancer: 'Off'
                      }
                  };

                  const config = presets[preset];
                  if (config) {
                      this.setDSP(config.dsp);
                      this.setDialogueLevel(config.dialogue);
                      // Apply other settings...
                      this.showMessage(`${preset.charAt(0).toUpperCase() + preset.slice(1)} Preset geladen`, 'success');
                  }
              }

              saveCurrentPreset() {
                  // Get current settings and save to localStorage
                  const preset = {
                      volume: this.elements.volumeSlider.value,
                      input: this.elements.inputBtns.find(btn => btn.classList.contains('active'))?.dataset.input,
                      // Add more current settings...
                  };
                  
                  localStorage.setItem('yamaha-user-preset', JSON.stringify(preset));
                  this.showMessage('Preset gespeichert', 'success');
              }

              loadUserPreset() {
                  const preset = localStorage.getItem('yamaha-user-preset');
                  if (preset) {
                      const config = JSON.parse(preset);
                      // Apply saved settings...
                      this.showMessage('Benutzer-Preset geladen', 'success');
                  } else {
                      this.showMessage('Kein Preset gefunden', 'error');
                  }
              }

              // System Information
              async loadSystemInfo() {
                  try {
                      // Get system info
                      const sysInfoXml = `<YAMAHA_AV cmd="GET"><System><Config>GetParam</Config></System></YAMAHA_AV>`;
                      const netInfoXml = `<YAMAHA_AV cmd="GET"><System><Misc>GetParam</Misc></System></YAMAHA_AV>`;
                      
                      const [sysResponse, netResponse] = await Promise.all([
                          this.sendCommand(sysInfoXml),
                          this.sendCommand(netInfoXml)
                      ]);

                      // Parse and display system info
                      const firmwareVersion = sysResponse.querySelector('Version')?.textContent || 'N/A';
                      this.elements.firmwareVersion.textContent = firmwareVersion;

                      // Network info would be parsed similarly
                      this.elements.networkIp.textContent = this.ip;
                      
                  } catch (error) {
                      console.error('Error loading system info:', error);
                      this.showMessage('Fehler beim Laden der Systeminformationen', 'error');
                  }
              }
          }

          // Initialize the application
          const receiver = new YamahaAdvancedReceiver();

      </script>
  </body>
  </html>